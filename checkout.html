<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <nav style="text-align: center; margin-bottom: 20px">
      <a href="shop.html" style="margin: 0 10px">Shop</a> |
      <a href="cart.html" style="margin: 0 10px">Cart</a> |
      <a href="checkout.html" style="margin: 0 10px">Checkout</a>
    </nav>

    <h1>Checkout</h1>

    <div class="cart-summary" id="cartSummary">
      <h3>Your Cart:</h3>
      <ul id="cartItems"></ul>
      <p>Total: $<span id="cartTotal">0.00</span></p>
    </div>

    <form id="checkoutForm">
      <input type="text" id="customerName" placeholder="Full Name" required />
      <input type="email" id="customerEmail" placeholder="Email" required />
      <button type="submit">Place Order</button>
    </form>

    <script>
      // Get cart from localStorage
      const cart = JSON.parse(localStorage.getItem("checkoutCart")) || [];
      const cartItemsEl = document.getElementById("cartItems");
      const cartTotalEl = document.getElementById("cartTotal");

      // Display cart items
      let total = 0;
      if (cart.length === 0) {
        cartItemsEl.innerHTML = "<li>Your cart is empty.</li>";
      } else {
        cart.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = `${item.name} x ${item.quantity} - $${(
            item.price * item.quantity
          ).toFixed(2)}`;
          cartItemsEl.appendChild(li);
          total += item.price * item.quantity;
        });
      }
      cartTotalEl.textContent = total.toFixed(2);

      // Determine backend URL (works locally or on Render)
      const BACKEND_URL = window.location.hostname.includes("localhost")
        ? "http://localhost:5000"
        : "";

      // Handle checkout form submission
      document
        .getElementById("checkoutForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          if (cart.length === 0) {
            alert("Your cart is empty!");
            return;
          }

          const orderData = {
            customerName: document.getElementById("customerName").value,
            customerEmail: document.getElementById("customerEmail").value,
            items: cart,
            total,
          };

          try {
            const res = await fetch(`${BACKEND_URL}/api/orders`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(orderData),
            });
            const data = await res.json();

            if (!res.ok) throw new Error(data.error || "Order failed");

            alert(data.message || "Order placed successfully!");
            localStorage.removeItem("checkoutCart");
            window.location.href = "shop.html"; // Redirect to shop
          } catch (err) {
            console.error("Error placing order:", err);
            alert(
              "There was an error placing your order. Please try again later."
            );
          }
        });
    </script>
  </body>
</html>
